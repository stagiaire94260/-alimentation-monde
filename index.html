<div id="alimentation-widget" style="width:100%; max-width:800px; margin:auto; font-family:Arial, sans-serif;">

<h2 style="text-align:center; color:#ff1a75; margin-bottom:15px;">Choisis ton alimentation en fonction de ton pays / préférences</h2>

<div class="preferences" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:15px;">
  <select id="continent" onchange="afficherPays()" style="padding:8px 12px; border-radius:10px; border:1px solid #ff1a75; background:#fff0f6; color:#ff1a75; font-weight:bold; cursor:pointer;">
    <option value="">-- Choisis ton continent --</option>
    <option value="Afrique">Afrique</option>
    <option value="Europe">Europe</option>
    <option value="Amérique">Amérique</option>
  </select>

  <select id="pays" style="display:none; padding:8px 12px; border-radius:10px; border:1px solid #ff1a75; background:#fff0f6; color:#ff1a75; font-weight:bold; cursor:pointer;" onchange="zoomPays()">
    <option value="">-- Choisis ton pays --</option>
  </select>

  <button onclick="genererMenu()" style="padding:8px 15px; border-radius:10px; border:1px solid #ff1a75; background:#fff0f6; color:#ff1a75; font-weight:bold; cursor:pointer;">Voir mon menu</button>
</div>

<div id="map" style="width:100%; height:400px; border-radius:15px; background:white; margin-bottom:15px;"></div>
<div id="menu"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// Encapsulation pour éviter conflit global
(function(){

var countriesData = {
  "Afrique": {
    "Sénégal": {
      coords:[14.4974,-14.4524],
      feculents:"Riz, attiéké, igname, fonio",
      proteines:"Poisson, poulet, niébé",
      legumes:"Gombo, bissap, épinards",
      fruits:"Mangue, papaye",
      plats:[
        {jour:"Lundi", petitdej:{plat:"Bouillie de mil", alt:"Bouillie avoine + fruits"}, 
         dej:{plat:"Thiéboudienne riz + poisson", alt:"Thiéboudienne + légumes vapeur"}, 
         collation:{plat:"Beignets de banane", alt:"Plantain poêlé ou au four"}, 
         diner:{plat:"Poulet Yassa + attiéké", alt:"Poulet Yassa + légumes"}},
        {jour:"Mardi", petitdej:{plat:"Pain de manioc + confiture", alt:"Pain complet + fruits"}, 
         dej:{plat:"Mafé + riz", alt:"Mafé + légumes vapeur"}, 
         collation:{plat:"Noix de cajou", alt:"Amandes grillées"}, 
         diner:{plat:"Poisson braisé + riz", alt:"Poisson vapeur + légumes"}},
        {jour:"Mercredi", petitdej:{plat:"Bouillie de fonio", alt:"Porridge avoine + fruits"}, 
         dej:{plat:"Yassa poulet + riz", alt:"Yassa poulet + quinoa"}, 
         collation:{plat:"Beignets de manioc", alt:"Carottes + houmous"}, 
         diner:{plat:"Soupe kandja", alt:"Soupe légumes + poulet"}},
        {jour:"Jeudi", petitdej:{plat:"Pain complet + beurre de cacahuète", alt:"Smoothie bowl"}, 
         dej:{plat:"Couscous sénégalais aux légumes", alt:"Couscous complet + légumes"}, 
         collation:{plat:"Bananes séchées", alt:"Fruits frais"}, 
         diner:{plat:"Tiep bou dienn", alt:"Poisson + légumes vapeur"}},
        {jour:"Vendredi", petitdej:{plat:"Crêpes de mil", alt:"Pancakes avoine + fruits"}, 
         dej:{plat:"Riz au poisson", alt:"Riz complet + poisson vapeur"}, 
         collation:{plat:"Noix de karité", alt:"Noix ou amandes"}, 
         diner:{plat:"Poulet DG", alt:"Poulet grillé + légumes"}},
        {jour:"Samedi", petitdej:{plat:"Bouillie de sorgho", alt:"Porridge + fruits"}, 
         dej:{plat:"Soupe kandia + riz", alt:"Soupe légumes + riz complet"}, 
         collation:{plat:"Beignets de banane", alt:"Fruit frais"}, 
         diner:{plat:"Yassa poisson + attiéké", alt:"Poisson + quinoa"}},
        {jour:"Dimanche", petitdej:{plat:"Pain de manioc", alt:"Smoothie bowl"}, 
         dej:{plat:"Mafé + riz", alt:"Mafé + légumes vapeur"}, 
         collation:{plat:"Noix de cajou", alt:"Fruits frais"}, 
         diner:{plat:"Thiéboudienne", alt:"Poisson vapeur + légumes"}}
      ]
    },

    "Maroc": {
      coords:[31.7917,-7.0926],
      feculents:"Couscous, pain, riz",
      proteines:"Agneau, poulet, poisson",
      legumes:"Carottes, courgettes, pois chiches",
      fruits:"Oranges, figues",
      plats:[
        {jour:"Lundi", petitdej:{plat:"Baghrir", alt:"Smoothie bowl"}, 
         dej:{plat:"Couscous aux légumes et poulet", alt:"Couscous complet + légumes"}, 
         collation:{plat:"Dattes", alt:"Fruits frais"}, 
         diner:{plat:"Tajine d’agneau aux pruneaux", alt:"Tajine léger légumes"}},
        {jour:"Mardi", petitdej:{plat:"Msemmen (crêpe feuilletée)", alt:"Porridge + fruits"}, 
         dej:{plat:"Tajine de poulet aux olives", alt:"Tajine légumes"}, 
         collation:{plat:"Fruits secs", alt:"Noix"}, 
         diner:{plat:"Harira (soupe traditionnelle)", alt:"Harira légère"}},
        {jour:"Mercredi", petitdej:{plat:"Baghrir + miel", alt:"Smoothie bowl"}, 
         dej:{plat:"Couscous royal", alt:"Couscous végétarien"}, 
         collation:{plat:"Amandes grillées", alt:"Fruits frais"}, 
         diner:{plat:"Tajine de kefta", alt:"Tajine légumes"}},
        {jour:"Jeudi", petitdej:{plat:"Msemen + confiture", alt:"Pancakes avoine"}, 
         dej:{plat:"Pastilla au poulet", alt:"Pastilla légère légumes"}, 
         collation:{plat:"Fruits frais", alt:"Noix"}, 
         diner:{plat:"Couscous aux légumes", alt:"Couscous complet"}},
        {jour:"Vendredi", petitdej:{plat:"Baghrir + beurre", alt:"Smoothie bowl"}, 
         dej:{plat:"Tajine de poisson", alt:"Tajine légumes"}, 
         collation:{plat:"Dattes", alt:"Fruits frais"}, 
         diner:{plat:"Rfissa (poulet + lentilles)", alt:"Rfissa légumes"}},
        {jour:"Samedi", petitdej:{plat:"Msemen + miel", alt:"Porridge"}, 
         dej:{plat:"Couscous aux légumes", alt:"Couscous complet"}, 
         collation:{plat:"Fruits secs", alt:"Noix"}, 
         diner:{plat:"Tajine d’agneau", alt:"Tajine légumes"}},
        {jour:"Dimanche", petitdej:{plat:"Baghrir", alt:"Smoothie bowl"}, 
         dej:{plat:"Couscous royal", alt:"Couscous végétarien"}, 
         collation:{plat:"Amandes", alt:"Fruits frais"}, 
         diner:{plat:"Harira", alt:"Soupe légumes"}}
      ]
    }
  }
};

var map = L.map('map', { center: [20, 0], zoom: 2, minZoom:1, maxZoom:5 });
var countryFillColor = "#ffc0cb";

fetch('https://stagiaire94260.github.io/-alimentation-monde/countriesData.json')
.then(res => res.json())
   .then(res => res.json())
  .then(data => {
    countriesData = data;
    console.log("Données des pays chargées", countriesData);
  })
  .catch(err => console.error("Erreur lors du chargement du fichier JSON", err));
.then(geojson => {
  L.geoJSON(geojson, {
    style: f=>({ fillColor: countryFillColor, color:"#fff", weight:1, fillOpacity:0.7 }),
    onEachFeature: function(feature, layer){
      layer.on('mouseover', function(){ this.setStyle({fillOpacity:1}); });
      layer.on('mouseout', function(){ this.setStyle({fillOpacity:0.7}); });
    }
  }).addTo(map);

  Object.keys(countriesData).forEach(cont=>{
    Object.keys(countriesData[cont]).forEach(p=>{
      let d = countriesData[cont][p];
      let marker = L.circleMarker(d.coords, {
        radius: 6, fillColor: "#ff4d91", color: "#fff", weight:2, fillOpacity:1
      }).addTo(map);

      marker.bindPopup(`<div style="font-size:13px; line-height:1.4;">
        <b>${p}</b> (${cont})<br>
        Féculents: ${d.feculents}<br>
        Protéines: ${d.proteines}<br>
        Légumes: ${d.legumes}<br>
        Fruits: ${d.fruits}
      </div>`);

      marker.on('click', function(){
        document.getElementById("continent").value = cont;
        afficherPays();
        document.getElementById("pays").value = p;
        genererMenu();
        map.setView(d.coords,5);
      });
    });
  });
});

// Selects
window.afficherPays = function(){
  let cont = document.getElementById("continent").value;
  let paysSelect = document.getElementById("pays");
  paysSelect.style.display = cont?"inline-block":"none";
  paysSelect.innerHTML = "<option value=''>-- Choisis ton pays --</option>";
  if(cont){
    Object.keys(countriesData[cont]).forEach(p=>{
      let o = document.createElement("option");
      o.value=p; o.textContent=p;
      paysSelect.appendChild(o);
    });
  }
}

window.zoomPays = function(){
  let cont = document.getElementById("continent").value;
  let p = document.getElementById("pays").value;
  if(cont && p){
    let coords = countriesData[cont][p].coords;
    map.setView(coords,5);
  }
}

window.genererMenu = function(){
  let cont = document.getElementById("continent").value;
  let p = document.getElementById("pays").value;
  if(!cont || !p) return alert("Choisis ton continent et ton pays");

  let menuDiv = document.getElementById("menu");
  menuDiv.innerHTML="";
  let menu = countriesData[cont][p].plats;
  if(!menu || menu.length===0) return menuDiv.innerHTML="Menu non disponible";

  menu.forEach(day=>{
    let dayCard = document.createElement("div");
    dayCard.style.marginBottom="12px"; dayCard.style.background="#fbc4e3"; dayCard.style.borderRadius="15px";
    dayCard.style.boxShadow="0 4px 15px rgba(0,0,0,0.1)"; dayCard.style.overflow="hidden";

    let header = document.createElement("div");
    header.style.padding="12px"; header.style.cursor="pointer"; header.style.color="white";
    header.style.fontWeight="bold"; header.textContent=day.jour;
    dayCard.appendChild(header);

    let mealsContainer = document.createElement("div");
    mealsContainer.style.display="none"; mealsContainer.style.padding="10px"; mealsContainer.style.background="#fff0f6";

    ["petitdej","dej","collation","diner"].forEach(meal=>{
      let mc = document.createElement("div");
      mc.style.marginBottom="8px"; mc.style.padding="8px"; mc.style.borderRadius="10px";
      mc.style.background="white"; mc.style.borderLeft="4px solid #ff1a75";
      mc.addEventListener("mouseover",()=>{ mc.style.background="#ffe6f0"; });
      mc.addEventListener("mouseout",()=>{ mc.style.background="white"; });

      let mealTitle = meal==="petitdej"?"Petit-déjeuner":meal==="dej"?"Déjeuner":meal==="collation"?"Collation":"Dîner";
      mc.innerHTML = `<strong>${mealTitle}</strong>${day[meal].plat}<div style="font-size:12px; font-style:italic; color:#666; margin-top:3px;">Alternative healthy: ${day[meal].alt}</div>`;
      mealsContainer.appendChild(mc);
    });

    header.addEventListener("click",()=>{ mealsContainer.style.display = mealsContainer.style.display==="block"?"none":"block"; });
    dayCard.appendChild(mealsContainer);
    menuDiv.appendChild(dayCard);
  });
}

})();
</script>
</div>
